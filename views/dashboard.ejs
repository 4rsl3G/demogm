<%
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
%>

<%-
  include("layout", {
    title: "Dashboard",
    toast,
    otp_modal_body: "", // dashboard ga butuh modal
    body: `
      <div class="grid">
        <div class="card">
          <div class="title"><i class="ri-store-2-line"></i> Merchant Tools</div>
          <div class="muted"><b>Note:</b> ${note}</div>

          <div style="height:12px"></div>

          <div class="card soft">
            <div class="title" style="margin:0 0 10px 0"><i class="ri-search-line"></i> Get Merchant ID</div>
            <form method="post" action="/merchant" data-loading="1">
              <button class="btn primary" type="submit"><i class="ri-download-cloud-line"></i> Get Merchant</button>
            </form>
            <div class="muted" style="margin-top:10px">
              Merchant ID: <b><%= merchantId || "-" %></b>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="card soft">
            <div class="title" style="margin:0 0 10px 0"><i class="ri-receipt-line"></i> Get Mutasi (Manual)</div>
            <form method="post" action="/mutasi" class="row" data-loading="1">
              <input class="inp" name="merchantId" value="<%= merchantId || '' %>" placeholder="Merchant ID (klik Get Merchant dulu)" />
              <button class="btn primary" type="submit"><i class="ri-file-list-3-line"></i> Get Mutasi Simple</button>
              <div class="muted">
                Mutasi hanya diambil saat tombol ditekan (tanpa auto polling).
              </div>
            </form>
          </div>

          <div style="height:12px"></div>

          <form method="post" action="/logout" data-loading="1">
            <button class="btn danger" type="submit"><i class="ri-logout-circle-r-line"></i> Logout</button>
          </form>
        </div>

        <div class="card">
          <div class="title"><i class="ri-braces-line"></i> Result JSON (Simple)</div>

          ${
            json
              ? `
                <div class="actions" style="margin-bottom:10px">
                  <button class="btn secondary" type="button" onclick="copyText('jsonOut')">
                    <i class="ri-file-copy-line"></i> Copy JSON
                  </button>
                  <span class="pill"><i class="ri-check-line"></i> Count: ${(json.count ?? "-")}</span>
                </div>
                <pre id="jsonOut">${escapeHtml(JSON.stringify(json, null, 2))}</pre>
              `
              : `
                <div class="muted">
                  Belum ada output. Klik <b>Get Merchant</b> lalu <b>Get Mutasi</b>.
                </div>
                <div style="height:12px"></div>
                <pre>{
  "ok": true,
  "merchant_id": "…",
  "date": "YYYY-MM-DD",
  "range": { "fromISO": "...", "toISO": "..." },
  "count": 0,
  "transactions": [],
  "note": "Credential tidak disimpan…"
}</pre>
              `
          }
        </div>
      </div>
    `
  })
%>
