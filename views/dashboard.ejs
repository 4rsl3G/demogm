<%
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
const mid = merchantId || "";
%>

<%-
  include("layout", {
    title: "Dashboard",
    toast,
    otp_modal_body: "",
    body: `
      <div class="grid">

        <div class="card">
          <div class="title"><i class="ri-tools-line"></i> Actions</div>
          <div class="muted">
            <b>Note:</b> ${note}<br/>
            Klik tombol untuk ambil data secara manual.
          </div>

          <div style="height:12px"></div>

          <div class="card soft" style="padding:12px">
            <div style="font-weight:950;font-size:13.5px; display:flex; align-items:center; gap:8px">
              <i class="ri-store-2-line"></i> Merchant ID
            </div>
            <div class="muted" style="margin-top:4px">
              <b><%= mid ? mid : "-" %></b>
            </div>
            <div style="height:10px"></div>

            <form method="post" action="/merchant" data-loading="1">
              <button class="btn primary" type="submit"><i class="ri-download-cloud-line"></i> Get Merchant</button>
            </form>

            <div class="muted" style="margin-top:10px">
              Ambil Merchant ID otomatis dari akun yang sudah connect.
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="card soft" style="padding:12px">
            <div style="font-weight:950;font-size:13.5px; display:flex; align-items:center; gap:8px">
              <i class="ri-receipt-line"></i> Mutasi (Manual)
            </div>
            <div class="muted" style="margin-top:4px">
              Ambil mutasi “simple JSON” untuk hari ini.
            </div>

            <div style="height:10px"></div>

            <form method="post" action="/mutasi" class="row" data-loading="1">
              <div class="row" style="gap:8px">
                <label class="muted" style="font-weight:900">Merchant ID</label>
                <input class="inp" name="merchantId" value="<%= mid %>" placeholder="Klik Get Merchant dulu agar terisi otomatis" />
              </div>

              <div class="actions">
                <button class="btn primary" type="submit"><i class="ri-file-list-3-line"></i> Get Mutasi</button>
                <button class="btn secondary" type="button" onclick="toastr.info('Mutasi tidak dipolling otomatis. Klik tombol untuk fetch manual.')">
                  <i class="ri-information-line"></i> Info
                </button>
              </div>

              <div class="muted">
                <i class="ri-timer-line"></i> Tidak ada auto polling untuk menghindari limit & beban.
              </div>
            </form>
          </div>

          <div style="height:12px"></div>

          <div class="card soft" style="padding:12px; border:1px solid rgba(220,38,38,.18); background: rgba(220,38,38,.04)">
            <div style="font-weight:950;font-size:13.5px; display:flex; align-items:center; gap:8px; color:#b91c1c">
              <i class="ri-alert-line"></i> Logout
            </div>
            <div class="muted" style="margin-top:4px">
              Menghapus session cookie (token sesi).
            </div>
            <div style="height:10px"></div>
            <form method="post" action="/logout" data-loading="1">
              <button class="btn danger" type="submit"><i class="ri-logout-circle-r-line"></i> Logout</button>
            </form>
          </div>
        </div>

        <div class="card">
          <div class="split" style="justify-content:space-between; align-items:flex-start">
            <div>
              <div class="title" style="margin:0"><i class="ri-braces-line"></i> Result</div>
              <div class="muted" style="margin-top:6px">
                Output simple JSON biar gampang dicopy untuk integrasi.
              </div>
            </div>

            ${
              json
                ? `
                  <div class="actions" style="justify-content:flex-end">
                    <button class="btn secondary" type="button" onclick="copyText('jsonOut')" style="width:auto">
                      <i class="ri-file-copy-line"></i> Copy
                    </button>
                    <span class="pill" style="display:inline-flex" title="Jumlah transaksi">
                      <i class="ri-hashtag"></i> Count: ${(json.count ?? "-")}
                    </span>
                  </div>
                `
                : `
                  <div class="actions" style="justify-content:flex-end">
                    <button class="btn secondary" type="button" onclick="toastr.info('Belum ada output. Klik Get Merchant lalu Get Mutasi.')" style="width:auto">
                      <i class="ri-sparkling-line"></i> Guide
                    </button>
                  </div>
                `
            }
          </div>

          <div style="height:12px"></div>

          ${
            json
              ? `
                <pre id="jsonOut">${escapeHtml(JSON.stringify(json, null, 2))}</pre>
                <div class="muted" style="margin-top:10px">
                  <i class="ri-lock-line"></i> Credential tidak disimpan. Session hanya sementara (cookie httpOnly terenkripsi).
                </div>
              `
              : `
                <div class="card soft" style="padding:12px">
                  <div style="font-weight:950;font-size:13.5px; display:flex; align-items:center; gap:8px">
                    <i class="ri-flag-line"></i> Belum ada data
                  </div>
                  <div class="muted" style="margin-top:4px">
                    Mulai dari <b>Get Merchant</b> agar Merchant ID terisi otomatis.
                  </div>
                </div>

                <div style="height:12px"></div>

                <pre>{
  "ok": true,
  "merchant_id": "…",
  "date": "YYYY-MM-DD",
  "range": { "fromISO": "...", "toISO": "..." },
  "count": 0,
  "transactions": [],
  "note": "Credential tidak disimpan…"
}</pre>
              `
          }
        </div>
      </div>

      <script>
        (function(){
          const mid = ${JSON.stringify(mid)};
          const t = window.__TOAST__;
          if (!mid && !t) setTimeout(()=>toastr.info("Klik Get Merchant dulu agar Merchant ID terisi."), 500);
        })();
      </script>
    `
  })
%>
