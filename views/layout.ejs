<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
  <title><%= title %></title>

  <!-- RemixIcon -->
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet">

  <!-- Toastr -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">

  <style>
    :root{
      --bg: #f5f7fb;
      --card: #ffffff;
      --text: #0b1220;
      --muted: #5b6676;
      --line: rgba(12,20,32,.10);

      --brand: #0f3d2e;
      --brand2: #145a42;
      --brandSoft: rgba(15,61,46,.10);
      --brandRing: rgba(15,61,46,.16);

      --shadow: 0 10px 26px rgba(16,24,40,.10);
      --shadow2: 0 20px 60px rgba(16,24,40,.14);

      --r: 18px;
      --r2: 22px;

      --fs12: 12.5px;
      --fs13: 13.3px;
      --fs14: 14px;
      --fs15: 15px;
      --fs16: 16px;

      --tap: 46px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      -webkit-font-smoothing: antialiased;
      overflow-x:hidden;
    }

    /* subtle background */
    .bg{
      position:fixed; inset:0; z-index:-1;
      background:
        radial-gradient(900px 520px at 10% 8%, rgba(15,61,46,.10), transparent 55%),
        radial-gradient(760px 520px at 92% 18%, rgba(15,61,46,.07), transparent 55%),
        radial-gradient(900px 560px at 55% 95%, rgba(20,90,66,.06), transparent 55%),
        linear-gradient(#f5f7fb, #f5f7fb);
    }

    /* container - mobile first */
    .wrap{
      max-width: 1120px;
      margin: 0 auto;
      padding: 14px;
      display:grid;
      gap: 12px;
      padding-bottom: 20px;
    }

    /* topbar - mobile first */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px;
      border-radius: var(--r2);
      border:1px solid var(--line);
      background: var(--card);
      box-shadow: var(--shadow);
      position: sticky;
      top: 10px;
      z-index: 10;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }

    .logo{
      width:44px;height:44px;
      border-radius: 14px;
      display:grid;place-items:center;
      color: var(--brand);
      background:
        radial-gradient(18px 18px at 30% 25%, rgba(15,61,46,.18), transparent 60%),
        linear-gradient(180deg, rgba(15,61,46,.10), rgba(15,61,46,.05));
      border:1px solid rgba(15,61,46,.16);
      flex:0 0 auto;
    }

    .brand h1{
      margin:0;
      font-size: 14.8px;
      font-weight: 950;
      letter-spacing: .2px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .brand .sub{
      margin-top:2px;
      color: var(--muted);
      font-size: var(--fs12);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .nav{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .pill{
      display:none; /* mobile hide */
      align-items:center;
      gap:8px;
      padding: 9px 12px;
      border-radius:999px;
      background: rgba(15,61,46,.08);
      border: 1px solid rgba(15,61,46,.14);
      color: var(--brand);
      font-weight: 900;
      font-size: var(--fs12);
      white-space: nowrap;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      height: 40px;
      padding: 0 12px;
      border-radius: 999px;
      background: #fff;
      border: 1px solid var(--line);
      color: rgba(11,18,32,.86);
      font-weight: 900;
      font-size: var(--fs12);
      cursor: pointer;
      user-select:none;
      transition: transform .12s ease, box-shadow .12s ease;
      text-decoration:none;
    }
    .chip:active{ transform: scale(.99); }
    .chip:hover{ box-shadow: 0 10px 20px rgba(16,24,40,.10); }

    /* layout */
    .grid{
      display:grid;
      gap: 12px;
      grid-template-columns: 1fr; /* mobile first */
    }

    /* cards */
    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--r2);
      padding: 14px;
      box-shadow: var(--shadow);
    }
    .card.soft{
      background: rgba(255,255,255,.75);
      box-shadow: none;
    }

    .title{
      margin:0 0 10px 0;
      display:flex;
      align-items:center;
      gap:10px;
      font-weight: 950;
      font-size: var(--fs15);
      letter-spacing:.1px;
    }
    .muted{
      color: var(--muted);
      font-size: var(--fs13);
      line-height: 1.65;
    }

    .row{ display:grid; gap:10px; }
    .split{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; }

    /* inputs */
    .inp{
      height: 48px;
      width: 100%;
      padding: 0 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: #fbfcff;
      color: var(--text);
      outline:none;
      transition: border-color .12s ease, box-shadow .12s ease, transform .12s ease;
    }
    .inp:focus{
      border-color: rgba(15,61,46,.38);
      box-shadow: 0 0 0 5px var(--brandRing);
      transform: translateY(-1px);
    }
    .inp::placeholder{ color: rgba(91,102,118,.70); }

    /* buttons */
    .btn{
      height: var(--tap);
      padding: 0 14px;
      border-radius: 14px;
      border: 1px solid rgba(15,61,46,.18);
      background: rgba(15,61,46,.10);
      color: var(--brand);
      font-weight: 950;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition: transform .12s ease, background .12s ease, box-shadow .12s ease;
      user-select:none;
      text-decoration:none;
      width: 100%; /* mobile first full */
    }
    .btn:active{ transform: scale(.99); }
    .btn:hover{ box-shadow: 0 10px 20px rgba(16,24,40,.10); }

    .btn.primary{
      border-color: rgba(15,61,46,.22);
      background: linear-gradient(180deg, var(--brand2), var(--brand));
      color:#fff;
      box-shadow: 0 14px 30px rgba(15,61,46,.18);
    }
    .btn.primary:hover{ background: linear-gradient(180deg, #17664a, var(--brand2)); }
    .btn.secondary{
      background: #fff;
      border-color: var(--line);
      color: rgba(11,18,32,.92);
      box-shadow: none;
    }
    .btn.danger{
      background: rgba(220,38,38,.10);
      border-color: rgba(220,38,38,.18);
      color: #b91c1c;
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; box-shadow:none; }

    /* tabs */
    .tabs{
      display:flex;
      padding: 6px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: #f2f4f8;
      gap:6px;
    }
    .tab{
      flex:1;
      border:0;
      border-radius: 999px;
      padding: 11px 12px;
      background: transparent;
      color: rgba(11,18,32,.70);
      font-weight: 950;
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
      cursor:pointer;
      transition: background .12s ease, transform .12s ease, box-shadow .12s ease;
    }
    .tab:active{ transform: scale(.99); }
    .tab.active{
      background: #fff;
      box-shadow: 0 8px 20px rgba(16,24,40,.10);
      color: var(--brand);
    }

    /* JSON */
    pre{
      margin:0;
      padding:14px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: #0b1220;
      color: #e7eefc;
      font-size: 12px;
      line-height: 1.55;
      overflow:auto;
      box-shadow: var(--shadow2);
      -webkit-overflow-scrolling: touch;
    }

    /* OTP Modal */
    .modal{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 80;
      background: rgba(2,6,23,.45);
      backdrop-filter: blur(7px);
    }
    .modal.show{ display:flex; }

    .modal-card{
      width: min(540px, 100%);
      background: #fff;
      border-radius: 22px;
      border: 1px solid rgba(15,61,46,.16);
      box-shadow: 0 34px 90px rgba(2,6,23,.38);
      overflow:hidden;
      transform: translateY(8px) scale(.98);
      opacity: 0;
      animation: modalIn .18s ease forwards;
    }
    @keyframes modalIn{ to{ transform: translateY(0) scale(1); opacity:1; } }

    .modal-head{
      padding: 14px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      border-bottom: 1px solid var(--line);
      background:
        radial-gradient(480px 120px at 14% 0%, rgba(15,61,46,.12), transparent 65%),
        linear-gradient(180deg, rgba(15,61,46,.10), rgba(15,61,46,0));
    }
    .modal-head .h{
      display:flex;align-items:center;gap:10px;
      font-weight: 950;
      color: var(--brand);
    }
    .xbtn{
      width: 42px;height: 42px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: #fff;
      cursor:pointer;
      display:grid;place-items:center;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .xbtn:active{ transform: scale(.99); }
    .xbtn:hover{ box-shadow: 0 10px 20px rgba(16,24,40,.10); }
    .modal-body{ padding: 14px; }

    .otp-timer{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      background: rgba(15,61,46,.08);
      border: 1px solid rgba(15,61,46,.14);
      color: var(--brand);
      font-weight: 950;
      font-size: var(--fs12);
      white-space: nowrap;
    }

    .otp-grid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
    }
    .otp-box{
      height: 54px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: #fbfcff;
      text-align:center;
      font-size: 18px;
      font-weight: 950;
      outline:none;
      transition: box-shadow .12s ease, border-color .12s ease, transform .12s ease, background .12s ease;
    }
    .otp-box:focus{
      border-color: rgba(15,61,46,.38);
      box-shadow: 0 0 0 5px var(--brandRing);
      transform: translateY(-1px);
    }
    .otp-box.filled{
      border-color: rgba(15,61,46,.22);
      background: rgba(15,61,46,.05);
    }

    .otp-hint{
      margin-top: 10px;
      font-size: var(--fs13);
      color: var(--muted);
      line-height:1.45;
    }
    .otp-hint.err{ color: #b91c1c; }

    @keyframes shakeSoft {
      0%,100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      50% { transform: translateX(5px); }
      75% { transform: translateX(-3px); }
    }
    .shakeSoft { animation: shakeSoft .28s ease; }

    /* overlay */
    .overlay{
      position:fixed; inset:0;
      background: rgba(2,6,23,.28);
      backdrop-filter: blur(6px);
      display:none; align-items:center; justify-content:center;
      z-index: 90;
    }
    .overlay.show{ display:flex; }
    .spinner{
      width:54px;height:54px;border-radius:999px;
      border:3px solid rgba(255,255,255,.25);
      border-top-color: rgba(255,255,255,.95);
      animation: spin .8s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg) } }

    /* desktop enhancements */
    @media (min-width: 920px){
      .wrap{ padding: 18px; gap: 14px; }
      .grid{ grid-template-columns: 1.2fr .8fr; gap: 14px; }
      .pill{ display:inline-flex; }
      .btn{ width: auto; }
    }

    /* small phones */
    @media (max-width: 380px){
      .otp-grid{ gap:8px; }
      .otp-box{ height: 48px; font-size: 17px; }
    }

    @media (prefers-reduced-motion: reduce){
      *{ transition: none !important; animation: none !important; }
    }
  </style>
</head>

<body>
  <div class="bg"></div>

  <div class="overlay" id="overlay">
    <div style="display:grid;gap:12px;place-items:center">
      <div class="spinner"></div>
      <div class="muted" style="color:#fff;text-align:center;font-weight:900">Processing...</div>
    </div>
  </div>

  <!-- OTP MODAL -->
  <div class="modal" id="otpModal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-label="OTP Verification">
      <div class="modal-head">
        <div class="h"><i class="ri-shield-keyhole-line"></i> Verifikasi OTP</div>
        <button class="xbtn" type="button" id="otpCloseBtn" aria-label="Close">
          <i class="ri-close-line"></i>
        </button>
      </div>
      <div class="modal-body">
        <%- (otp_modal_body || "") %>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"><i class="ri-leaf-line"></i></div>
        <div style="min-width:0">
          <h1>GoBiz Connect Toolkit</h1>
          <div class="sub">Connect → Merchant → Mutasi (Simple JSON)</div>
        </div>
      </div>

      <div class="nav">
        <span class="pill"><i class="ri-lock-line"></i> Credential tidak disimpan</span>
        <a class="chip" href="/"><i class="ri-home-4-line"></i> Home</a>
        <a class="chip" href="/dashboard"><i class="ri-dashboard-line"></i> Dashboard</a>
      </div>
    </div>

    <%- body %>
  </div>

  <!-- Toastr -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

  <script>
    toastr.options = {
      closeButton: true,
      progressBar: true,
      positionClass: "toast-top-right",
      timeOut: "3200",
      extendedTimeOut: "1200",
      showDuration: "150",
      hideDuration: "150"
    };

    // loading overlay for forms
    (function(){
      const overlay = document.getElementById("overlay");
      document.querySelectorAll("form[data-loading='1']").forEach((f)=>{
        f.addEventListener("submit", ()=>{
          overlay.classList.add("show");
          setTimeout(()=>overlay.classList.remove("show"), 12000);
        });
      });
    })();

    // toast from server
    window.__TOAST__ = <%- JSON.stringify(toast || null) %>;
    if (window.__TOAST__) {
      const t = window.__TOAST__.type || "info";
      const m = window.__TOAST__.message || "";
      if (toastr[t]) toastr[t](m);
      else toastr.info(m);
    }

    // segmented tabs
    window.setTab = (tabId) => {
      document.querySelectorAll("[data-tab]").forEach(el => el.style.display = "none");
      document.querySelectorAll("[data-tabbtn]").forEach(el => el.classList.remove("active"));
      const tab = document.querySelector("[data-tab='"+tabId+"']");
      const btn = document.querySelector("[data-tabbtn='"+tabId+"']");
      if (tab) tab.style.display = "block";
      if (btn) btn.classList.add("active");
      location.hash = tabId === "otp" ? "otp" : "";
    };

    window.copyText = async (id) => {
      const el = document.getElementById(id);
      if (!el) return;
      try {
        await navigator.clipboard.writeText(el.innerText || el.textContent || "");
        toastr.success("Copied!");
      } catch {
        toastr.error("Copy failed");
      }
    };
  </script>

  <!-- OTP Modal + OTP 6 box + countdown + autosubmit -->
  <script>
  (function(){
    const modal = document.getElementById("otpModal");
    const closeBtn = document.getElementById("otpCloseBtn");
    const getEl = (id) => document.getElementById(id);

    function showModal(){
      if (!modal) return;
      modal.classList.add("show");
      modal.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
      setTimeout(()=>{
        const grid = getEl("otpGrid");
        const first = grid?.querySelector("input.otp-box");
        if (first) first.focus();
      }, 60);
    }

    function hideModal(){
      if (!modal) return;
      modal.classList.remove("show");
      modal.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
    }

    if (closeBtn) closeBtn.addEventListener("click", hideModal);
    if (modal) modal.addEventListener("click", (e) => { if (e.target === modal) hideModal(); });
    document.addEventListener("keydown", (e) => { if (e.key === "Escape" && modal?.classList.contains("show")) hideModal(); });

    window.__showOtpModal = showModal;
    window.__hideOtpModal = hideModal;

    // auto open modal if query otp=1
    const usp = new URLSearchParams(location.search);
    if (usp.get("otp") === "1") showModal();

    // ===== OTP logic =====
    const form = getEl("otpVerifyForm");
    const grid = getEl("otpGrid");
    const hidden = getEl("otpHidden");
    const btn = getEl("otpVerifyBtn");
    const clearBtn = getEl("otpClearBtn");
    const countdownEl = getEl("otpCountdown");
    const hint = getEl("otpHint");
    const overlay = getEl("overlay");

    if (!form || !grid || !hidden) return;

    const boxes = Array.from(grid.querySelectorAll("input.otp-box"));
    const OTP_LEN = 6;

    let active = false;
    let expiresAt = 0;
    let submitting = false;

    function shakeSoft(){
      grid.classList.remove("shakeSoft");
      void grid.offsetWidth;
      grid.classList.add("shakeSoft");
      setTimeout(()=>grid.classList.remove("shakeSoft"), 320);
    }
    function setHint(text, isError){
      if (!hint) return;
      hint.textContent = text || "";
      hint.classList.toggle("err", !!isError);
    }
    function sanitizeDigit(v){ return (v||"").replace(/\D/g,"").slice(0,1); }
    function readOtp(){ return boxes.map(b => (b.value||"").trim()).join(""); }

    function syncUI(){
      const otp = readOtp();
      hidden.value = otp;
      boxes.forEach(b => b.classList.toggle("filled", !!b.value));
      if (btn) btn.disabled = (!active) || otp.length !== OTP_LEN || submitting;

      if (!active) setHint("Klik Request OTP dulu.", false);
      else if (expiresAt && Date.now() > expiresAt) setHint("OTP expired. Request ulang.", true);
      else setHint(" ", false);
    }

    function focusAt(i){ const el = boxes[i]; if (el) el.focus(); }

    async function submitIfReady(){
      const otp = readOtp();
      if (!active) return;
      if (expiresAt && Date.now() > expiresAt) return;
      if (submitting) return;
      if (otp.length !== OTP_LEN) return;

      submitting = true;
      syncUI();
      overlay?.classList.add("show");
      try{
        form.requestSubmit ? form.requestSubmit() : form.submit();
      } catch {
        submitting = false;
        overlay?.classList.remove("show");
        toastr.error("Submit gagal");
      }
    }

    boxes.forEach((b, i) => {
      b.addEventListener("input", async () => {
        b.value = sanitizeDigit(b.value);
        syncUI();
        if (b.value && i < boxes.length - 1) focusAt(i + 1);
        await submitIfReady();
      });
      b.addEventListener("keydown", (e) => {
        if (e.key === "Backspace" && !b.value && i > 0) {
          boxes[i - 1].value = "";
          focusAt(i - 1);
          syncUI();
        }
        if (e.key === "ArrowLeft" && i > 0) focusAt(i - 1);
        if (e.key === "ArrowRight" && i < boxes.length - 1) focusAt(i + 1);
      });
      b.addEventListener("paste", async (e) => {
        const text = (e.clipboardData || window.clipboardData).getData("text") || "";
        const digits = text.replace(/\D/g, "").slice(0, OTP_LEN);
        if (!digits) return;
        e.preventDefault();
        for (let k = 0; k < boxes.length; k++) boxes[k].value = digits[k] || "";
        syncUI();
        focusAt(Math.min(digits.length, boxes.length - 1));
        await submitIfReady();
      });
    });

    if (clearBtn){
      clearBtn.addEventListener("click", () => {
        boxes.forEach(b => b.value = "");
        submitting = false;
        syncUI();
        focusAt(0);
      });
    }

    form.addEventListener("submit", (e) => {
      const otp = readOtp();
      if (!active){
        e.preventDefault();
        setHint("Klik Request OTP dulu.", true);
        shakeSoft();
        toastr.warning("Request OTP dulu");
        return;
      }
      if (expiresAt && Date.now() > expiresAt){
        e.preventDefault();
        setHint("OTP expired. Request ulang.", true);
        shakeSoft();
        toastr.error("OTP expired. Request ulang.");
        return;
      }
      if (otp.length !== OTP_LEN){
        e.preventDefault();
        setHint("OTP belum lengkap.", true);
        shakeSoft();
        toastr.warning("OTP belum lengkap");
        return;
      }
    });

    async function fetchStatus(){
      try{
        const r = await fetch("/otp/status", { cache: "no-store" });
        const j = await r.json();
        active = !!j.active;
        expiresAt = Number(j.expiresAt || 0) || 0;
        if (active && modal && !modal.classList.contains("show")) showModal();
        syncUI();
      } catch {}
    }

    function fmt(sec){
      const s = Math.max(0, sec|0);
      const m = Math.floor(s/60);
      const r = s%60;
      return String(m).padStart(2,"0")+":"+String(r).padStart(2,"0");
    }

    function tick(){
      if (!countdownEl) return;
      if (!active || !expiresAt){ countdownEl.textContent = "--:--"; return; }
      const left = Math.ceil((expiresAt - Date.now()) / 1000);
      countdownEl.textContent = fmt(left);
      if (left <= 0){
        active = false;
        submitting = false;
        syncUI();
        shakeSoft();
        toastr.error("OTP expired. Request ulang.");
      }
    }

    fetchStatus();
    tick();
    setInterval(fetchStatus, 5000);
    setInterval(tick, 1000);
  })();
  </script>

  <!-- OPTIONAL: Ajax Request OTP (recommended) -->
  <script>
  (function(){
    const form = document.getElementById("otpRequestForm");
    if (!form) return;

    form.addEventListener("submit", async (e) => {
      // jika kamu mau tetap redirect 302, hapus seluruh block ini.
      e.preventDefault();

      const overlay = document.getElementById("overlay");
      overlay?.classList.add("show");

      const params = new URLSearchParams();
      new FormData(form).forEach((v, k) => params.append(k, String(v)));

      try{
        const res = await fetch(form.action, {
          method: "POST",
          headers: {
            "Accept": "application/json",
            "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"
          },
          body: params.toString()
        });

        const data = await res.json().catch(()=> ({}));
        overlay?.classList.remove("show");

        if (!res.ok || !data.ok) {
          toastr.error(data.message || "OTP request gagal");
          return;
        }

        toastr.success(`OTP terkirim. Exp ${data.expiresIn}s`);
        window.__showOtpModal?.();
      } catch {
        overlay?.classList.remove("show");
        toastr.error("OTP request gagal (network)");
      }
    });
  })();
  </script>
</body>
</html>
